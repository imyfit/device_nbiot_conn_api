# 终端广域接口

| **版本** | **日期** | **备注**                                                     |
| :------: | :------: | :----------------------------------------------------------- |
|   2.21   | 20220410 | 1. 整理文档   <br />2. 删除1.4.3.6服务器通知终端关闭通信窗口   <br />3. 删除1.4.4.5里程离线数据 |
|   2.22   | 20220721 | 1. 短消息增加标题                                            |
|   2.23   | 20220803 | 1.增加NB上报参数配置 <br />2.完善GPS参数配置 <br />3.完善蓝牙扫描参数配置 |
|   2.24   | 20220817 | 完善GPS配置，增加定位成功延时关闭，定位数据上报间隔，定位数据过滤时间三个参数 |
|   2.25   | 20220824 | 1. 增加统一的WIFI扫描配置<br />2. 去掉之前的WIFI和FENCE配置  |
|   2.26   | 20220831 | 1. 纠错及增加示例<br />2.增加GPS数据解析                     |
|   2.27   | 20221017 | 运动事件增加sport2[增加里程，最大心率，平均心率]             |
|   2.28   | 20230310 | 1. 优化对各机型差异的说明<br />2. 纠错                       |

1. 本协议文档可能不是最新版本；
2. 本协议文档描述，Cat1&NB-Iot终端API；
3. 开发者若需要硬件对接请联系销售人员,  https://www.imyfit.com ；
4. 若协议文档有更新，不再另行通知，强烈建议开发者到 https://imyfit.gitee.io 获取在线最新协议；
5. 若有疑问请到ISSUE区提出 https://gitee.com/imyfit/imyfit-issue 愿我们的付出对您的开发事半功倍。

## 1.概述

API通信协议采用MQTT，而数据协议均采用JSON格式。考虑到终端计算能力有限，一部分接口采用一层字符/字符串形式的JSON，且不允许出现中文、中文字符；另外一些JSON采用多层。

### 1.1 MQTT协议说明

MQTT协议主题格式约定：类型/接收方/发送方/，具体主题如下表。

表格 1 主题

|    **主题**     | **备注**                           |
| :-------------: | ---------------------------------- |
| dev/{mac}/cloud | 云端定向指定终端发消息             |
| dev/cloud/{mac} | 终端向云端发消息，例如：定时数据等 |

如终端的mac为8C:D4:95:00:FF:FE，应用服务器消息发往该终端的主题则为：dev/8CD49500FFFE/cloud；终端消息发往应用服务器的主题为：dev/cloud/8CD49500FFFE。应用服务器订阅主题dev/cloud/#可以订阅所有终端发往云服务器的消息，通过主题区分消息来源哪个终端。**注意事项：消息数据键值中手环mac一般会省略冒号表示。主题MAC字母需要大写。**

### 1.2 数据收发说明

终端并不是一直处于接收数据状态，NB-Iot终端最后一条数据上报后有10秒处于接收数据状态，之后关闭接收。Cat1终端为5s。

## 2.异常接口

无效请求，或其它出现问题时，接口返回异常，用于向应用服务器和使用者声明请求无效的原因。异常情况代码和含义如下：

表格 2 异常代码

|     **异常情况描述代码**     | **异常情况数值代码** | **含义**                   |
| :--------------------------: | :------------------: | -------------------------- |
|           BAD_JSON           |         1000         | JSON格式错误               |
|        IP_BAD_REQUEST        |         1001         | 服务器无法识别的请求的操作 |
|         SENSOR_ERROR         |         1008         | 定位传感器出现错误         |
| NO_CONNECTION_TO_POSITIONING |         1009         | 没有建立定位连接服务       |
|      INVALID_PARAMETER       |         1010         | 请求的操作参数无效         |
|      MISSING_PARAMETER       |         1011         | 请求的操作缺参数           |
|  NO_POSITIONGING_TIME_LEFT   |         1012         | 没有足够的定位时间         |
|       NO_OFFLINE_DATA        |         1013         | 没有离线数据               |

示例：

```
{"SENSOR_ERROR": 1008}
```

## 3.公共接口

指UDP(UWB终端)和MQTT（NB-IoT终端）都可以执行的接口。应用服务器发起的交互消息的值应包含msg_id和终端mac，且用逗号分隔；msg_id用时间戳表示，例如：1566197383，单位秒【从北京时间1970年1月1日0点开始】。

注意：

（1）由于是公共接口，部分接口虽然有该功能，但终端不一定支持。

（2）从1.4.6接口开始msg_id和mac用键’dev’表示如："dev"**:**"1566197383,8cd49500fffe"，主动上报数据内容不一定包含键’dev’。

### 3.1 终端时间设置

用于设置终端的当前时间，可每天定时设置。

表格 3 时间设置

| **键**  | **类型** | **含义**                     |
| :-----: | :------: | ---------------------------- |
| setTime |  string  | msgid，终端mac，修改为的时间 |

示例：

**{**"setTime"**:**"1566197383,8cd49500fffe,20180910T120530"**}**

表格 4 时间设置应答

|   **键**   | **类型** | **含义**                     |
| :--------: | :------: | ---------------------------- |
| ackSetTime |  string  | msgid，终端mac，修改后的时间 |

示例：

**{**"ackSetTime"**:**"1566197383,8cd49500fffe,20180910T120530"**}**

### 3.2 终端消息发送

表格 5 发送消息

| **键**  | **类型** | **含义**                                                     |
| ------- | -------- | ------------------------------------------------------------ |
| title   | string   | 短消息标题。内容格式和短消息内容的格式一致，不包含 ’msg-‘ 部分。无此键则默认标题为"Server"。长度限制32字节，一个中文为3字节，英文字符为1个字节。 |
| sendMsg | string   | 向终端发送短消息，msg表示短消息，尖括号‘<>’括起来的为ASIIC格式的utf-8码。 |
| dev     | string   | msgid，mac                                                   |

示例：

发送短消息：“hello word!你好世界”，中文使用utf-8编码并转为ASIIC格式且用尖括号括起来。

**{** "sendMsg":"1566197383,e35dc73e730d,msg-hello word !<E4BDA0E5A5BDE4B896E7958C>","dev"**:**"1566197383,8cd49500fffe" **}**

示例2：

发送标题为”通知“的短消息：“这是一条通知。”，中文使用utf-8编码并转为ASIIC格式且用尖括号括起来。

**{**"sendMsg":"1657728358,c3ae93e507c2,msg-<e8bf99e698afe4b880e69da1e6b688e681afe38082>","title":"<e9809ae79fa5>","dev"**:**"1566197383,8cd49500fffe"**}**

表格 6 消息应答

| **键**     | **类型** | **含义**     |
| ---------- | -------- | ------------ |
| ackSendMsg | string   | 应答，"ok"。 |
| dev        | string   | msgid，mac   |

示例：

**{**"ackSendMsg":"ok","dev"**:**"1566197383,8cd49500fffe"**}**

## 4.MQTT接口

支持MQTT的终端接口。

### 4.1 定时信息上报

定时上报终端状态信息

**上报基础频率：**NB-IoT终端：5分钟一次；Cat1终端：10分钟一次

**降频状态：**

1. 佩戴进入睡眠状态：6*基础频率

2. 未佩戴状态【00：00--06：00】：12*基础频率

3. 未佩戴状态【其他时段】：2*基础频率

表格 7 定时上报

|       **键**        | **类型** | **含义**                                                     |
| :-----------------: | :------: | ------------------------------------------------------------ |
| outdoorLocationData |  object  | 定位信息等                                                   |
|    LocationData     |  string  | 数据格式请查阅：[上报定位数据格式表](#上报定位数据格式表)，本数据包最多携带2个定位点，若当前缓存多余两个定位点，则此处只显示定位点数量。实际数据通过[cacheLocationDatas](#日常定位信息上报数据格式表)上报[1.4.7]  [新的上报方式] |
|    locationTime     |  string  | 设备本地时间【格式YYYYMMDDTHHMMSS】                          |
|   additionMessage   |  object  | 电池电量、计步和心率等                                       |
|        tagID        |  string  | 终端MAC地址                                                  |
|       battery       |  string  | 电量[内容为int]【0-100】                                     |
|        step         |  string  | 计步【内容为int】                                            |
|       celsius       |  string  | isWear为yes时为人体温度，no时为环境温度  内容为float，单位摄氏度。精确到小数点后两位 |
|       isWear        |  string  | yes：佩戴，no：未佩戴                                        |
|        spo2         |   int    | 血氧浓度【设备支持及打开血氧连续监测才有数据】               |
|      diastolic      |   int    | 低压值【设备支持及打开血压连续监测才有数据】                 |
|      systolic       |   int    | 高压值【设备支持及打开血压连续监测才有数据】                 |
|      pressure       |  float   | 气压值，单位百帕，精确到小数点后两位【设备支持才有此键】     |
|      heartpack      |   int    | 标记接下来会上报的心率包个数【全为0或者255的心率包不再上报，比如在这个上报周期内，有4个包，但是其中有3个包全部为0和255，则heartpack为1，本周期内只会上报一个心率包】 |
|         csq         |   int    | 通信模块信号值                                               |
|        heart        |   int    | 当前心率值                                                   |
|       calorie       |   int    | 热量                                                         |
|     celsius_raw     |  string  | “float,float”, 环境温度，体表温度                            |
|         hrv         |  string  | “float,float,float,float,float”,分别表示SDNN，TP，LF，HF，VLF  数据处理参考：心理健康测评指标表 |

表格 8 心理健康测评指标表

| 指标名称 |  计算公式   |  差  |   中    |  好  |
| :------: | :---------: | :--: | :-----: | :--: |
| 精神压力 |  50+LF/100  | >68  | [58,68] | <58  |
|  疲劳度  |   TP/100    | <25  | [25,50] | >50  |
| 抗压能力 | 50+SDNN/10  | <60  | [60,70] | >70  |
| 调节能力 | 40+LF*10/HF | <55  | [55,60] | >60  |

```json
示例：
{"outdoorLocationData":{"LocationData":"0103001961a771280d92d61843eb5a5c","locationTime":"20211201T125714","tagID":"C71FE3058A57","additionMessage":{"battery":"100","step":"0","calorie":0,"heart":0,"celsius":"28.00","pressure":4893.35,"spo2":0,"diastolic":0,"systolic":0,"isWear":"No","csq":20,"heartpack":0}}}
说明：该协议最多上报两个定位点，更多缓存定位点通过协议cacheLocationDatas上报
```

### 4.2 心率监测上报（特殊接口，实时上报，功耗高）

终端保持网络连接，进行高频率（小于10秒）上报心率数据，终端将心率数据缓存，上报执行将缓存一次上报。

表格 9 设置心率实时上报

|      **键**      | **类型** | **含义**                                                     |
| :--------------: | :------: | ------------------------------------------------------------ |
| setNbHeartReport |  string  | open：打开，close：关闭，为空则为查询。                      |
|     interval     |   int    | 记录心率数据的时间间隔，单位：秒  对于NB模组的终端，建议大于5s |
|       dev        |  string  | msgid，mac                                                   |

```json
示例：
{"setNbHeartReport":"open","interval":5,"dev":"1566197383,ce46831fdb93"}
```

**响应：**

表格 10 手环响应设置心率实时上报

| **键**        | **类型** | **含义**                                                     |
| ------------- | -------- | ------------------------------------------------------------ |
| nbHeartReport | string   | 心率数据，个数不定。                                         |
| count         | int      | 上报的心率个数。                                             |
| interval      | int      | 每个心率数据的时间间隔，单位：秒                             |
| HeartTime     | string   | 上报第一个心率的采集时间 单位秒【从北京时间1970年1月1日0点开始】 |
| dev           | string   | msgid，mac                                                   |

```json
示例：{"nbHeartReport":"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0","count":27,"interval":5,"HeartTime":"1603278393","dev":"1603278393,ce46831fdb93"}
```

### 4.3 设置

#### 4.3.1 MQTT服务器配置（服务器地址配置我司测试服务器则不支持）

表格 11 MQTT服务器配置

|      **键**       | **类型** | **含义**         |
| :---------------: | :------: | ---------------- |
| mqttConfiguration |  object  | 服务器IP、端口等 |
|       host        |  string  | IP地址           |
|       port        |  string  | 端口，0~65535    |
|     clientId      |  string  | 客户端id         |
|     userName      |  string  | 用户名           |
|      passwrd      |  string  | 密码             |
|  topicSubscribe   |  string  | 订阅主题         |
|  topicPublisher   |  string  | 发布主题         |
|        qos        |   int    | 消息等级0~2      |
|     retained      |   int    | 消息保留开关     |

**注意：修改mqtt配置需谨慎，修改错误后将会导致无法通信，无法通过恢复出厂设置恢复默认配置。**

```json
示例：
只修改设置服务器和端口
{"mqttConfiguration":{"host":"114.116.23.249","port":"1883"},"dev":"1566197383,8cd49500fffe"}
响应：
{"mqttConfiguration":{"host":"114.116.23.249","port":1883,"clientId":"C460046645709170","qos":1,"retained":0,"topicPublisher":"dev/cloud/E35DC73E730D","topicSubscribe":"dev/E35DC73E730D/cloud","userName":"","userPasswrd":""},"dev"**:**"1566197383,8cd49500fffe"}
```

#### 4.3.2 自动校准时间

设置开启自动校准时间后将会通过NB网络或者GPS校准时间，优先通过NB网络设置。

表格 12 自动校准时间

|      **键**       | **类型** | **含义**                                |
| :---------------: | :------: | --------------------------------------- |
| setTimeAutoPeriod |  string  | open：开启自动校准，close：关闭自动校准 |
|        dev        |  string  | msgid，mac                              |

```json
示例：
开启自动校准时间：
{"setTimeAutoPeriod":"open","dev":"1566197383,8cd49500fffe"}
关闭自动校准时间：
{"setTimeAutoPeriod":"close","dev":"1566197383,8cd49500fffe"}
```

#### 4.3.3 设置学生信息【B10c，R9C不支持】

**设置：**

表格 13 设置学生信息

|     **键**     | **类型** | **含义**                |
| :------------: | :------: | ----------------------- |
| setStudentInfo |  string  | name：姓名，class：班级 |
|      dev       |  string  | msgid，mac              |

**响应：**

表格 14 手环响应设置学生信息

|      **键**       | **类型** | **含义**               |
| :---------------: | :------: | ---------------------- |
| ackSetStudentInfo |  string  | ok：成功，fail：失败。 |
|        dev        |  string  | msgid，mac             |

```json
示例：设置姓名张三，班级三年级2班，使用国标码并转换为ASIIC格式编码且用尖括号括起来。
{"setStudentInfo":"name:<D5C5C8FD>,class:<C8FDC4EABCB632B0E0>","dev":"1566197383,8cd49500fffe"}
{"ackSetStudentInfo":"ok","dev":"1566197383,8cd49500fffe"}
```

#### 4.3.4 系统参数设置接口

**设置：**

表格 15 系统参数设置

|       **键**       | **类型** | **含义**                                                 |
| :----------------: | :------: | -------------------------------------------------------- |
| setSystemParameter |  string  | query/set/del  查询/设置/清除  [仅remind和fence可以删除] |
|        type        |  string  | 参考参数类型表                                           |
|       state        |  string  | open/close 打开/关闭【设置字段】                         |
|       value        |  string  | 需要的参数，根据参数类型变化【设置字段】                 |
|        dev         |  string  | msgid，mac                                               |

**响应：**

表格 16 手环响应参数设置信息

|        **键**         | **类型** | **含义**                     |
| :-------------------: | :------: | ---------------------------- |
| ackSetSystemParameter |  string  | ok：成功，fail：失败。       |
|         type          |  string  | 参考参数类型表               |
|         state         |  string  | open/close 打开/关闭         |
|         value         |  string  | 需要的参数，根据参数类型变化 |
|          dev          |  string  | msgid，mac                   |

表格 17 参数类型表

|       **键值**        |     **含义**     |                      **对应state键值**                       | **对应value键值**                                            |
| :-------------------: | :--------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
|         heart         |     心率监测     |                          open/close                          | 开启/关闭心率实时模式，1s一个心率，替代1.4.2里面关于打开实时上报的协议 |
|    heart_execption    |     心率异常     |                          open/close                          | 预警最小值和最大值，中间用‘,’隔开。【默认值40，160】         |
|         spo2          |   血氧连续监测   |                          open/close                          | 连续监测间隔时间【分钟】，默认值5，可修改为5的倍数，最大60   |
|    spo2_execption     |     血氧异常     |                          open/close                          | 预警最小值和最大值，中间用‘,’隔开。                          |
|      temperature      |       体温       |                     默认开启，不支持关闭                     |                                                              |
| temperature_execption |     体温异常     |                          open/close                          | 预警最小值和最大值，中间用‘,’隔开。默认值35，38              |
|       pressure        |     气压监测     |                     默认开启，不支持关闭                     |                                                              |
|  pressure_execption   |     气压异常     |                          open/close                          | 预警最小值和最大值，中间用‘,’隔开。                          |
|     bloodpressure     |     血压监测     |                          open/close                          | 连续监测间隔时间【分钟】，默认值5，可修改为5的倍数，最大60   |
|     bp_execption      |     血压异常     |                          open/close                          | 收缩压预警最小值和最大值，舒张压预警最小值和最大值。中间用‘,’隔开。 |
|       diagnosis       |     诊断监测     |                          open/close                          | 连续监测间隔时间【分钟】，默认值5，可修改为5的倍数，最大60   |
|        remind         |    自定义提醒    |     自定义提醒总数+本数据包提醒数量。<br />中间逗号隔开      | 16进制字符串【解析请先将两个字节转换位一个16进制数】，删除时发送编号即可。  数据结构参考提醒参数表 |
|          hrv          |     Hrv监测      |                          open/close                          | 连续监测间隔时间【分钟】，默认值5，可修改为5的倍数，最大60   |
|        btscan         | 蓝牙扫描功能设置 | “scan_switch,<br />fence_switch,<br />flag,<br />period,<br />config_period,<br />timeout,<br />filter_name,<br />filter_rssi,<br />in_period, <br />out_period"<br />具体内容参考：  蓝牙扫描设置state参数表 | BT围栏数据  最多可以跟7个围栏数据  围栏数据参考围栏参数表    |
|       nb_config       |   远程上报控制   |                              无                              | 16进制字符串【解析请先将两个字节转换位一个16进制数】具体内容参考NB上报配置参数表 |
|     adv_frequency     | 广播间隔时间设置 |                              无                              | “广播间隔，静止广播间隔，SOS广播间隔”<br />单位10ms   默认"33,100,33" |
|       wifiscan        |   WIFI扫描配置   | “scan_switch,<br />fence_switch,<br />flag,<br />period,<br />config_period,<br />in_period, <br />out_period"<br />具体内容参考：  蓝牙扫描设置state参数表 | 最多可以跟7个围栏数据  围栏数据参考围栏参数表                |

表格 18 远程上报配置参数表

| 字节序号 | 说明                                                         |
| :------: | :----------------------------------------------------------- |
|    1     | 正常上报的频率，单位分钟，Cat1设备默认10，NB-Iot设备默认5    |
|    2     | 不佩戴上报频率，单位分钟，Cat1设备默认20，NB-Iot设备默认10   |
|    3     | 睡眠状态上报频率，单位分钟，Cat1设备默认60，NB-Iot设备默认30 |
|    4     | 不佩戴夜间上报频率，单位分钟，Cat1设备默认120，NB-Iot设备默认60 |
|   5-10   | 预留备用                                                     |
|  11-20   | 低电量上报频率，可设置5组，每组两个字节，分别表示电量和低于此电量则使用此频率上报，下发数据电量递增排列 |
|  21-40   | 2B一组，可设置10组时间段，例如0x04 0x05 0x08 0x09表示4点到5点，8点到9点都关闭上报 |
|    41    | 功能标记<br />0x80下发存储标记                               |

表格 19 蓝牙扫描设置state参数表

|   **字段**    | **类型** | **含义**                                                     |
| :-----------: | :------: | :----------------------------------------------------------- |
|  scan_switch  |   int    | 0关闭 1开启                                                  |
| fence_switch  |   int    | 用一个字节表示7个围栏的开关状态                              |
|     flag      |   int    | #0x00000001上报扫描数据<br />#0x00000002扫描结束立即上传数据<br />0x00000004只扫描beacon设备<br />0x00000008 只扫描我司设备b6,b7,b8<br />0x00000010 只扫描特定设备，filter_name过滤<br />0x00000020 只扫描一定范围内的设备 filter_rssi过滤<br />0x00000040 特定围栏，匹配filter_name则触发围栏<br />0x00000080 校时标记[仅支持我司网关校时]<br />0x00000100 扫描For围栏<br />#0x80000000 下发存储标记【用于收到后是否存储】<br />说明：WIFI只使用带#部分 |
|    period     |   int    | 扫描周期 单位秒 范围10-3600，**默认300**                     |
| config_period |   int    | 用于状态切换后确认状态的扫描周期 单位秒 范围 5-255，**默认5** |
|    timeout    |   int    | 一次扫描超时时间 单位毫秒 范围10-5000，**默认500**           |
|  filter_name  |  string  | 扫描过滤[终端名称]，最长10个字符，**默认为0**                |
|  filter_rssi  |   int    | 扫描过滤[rssi]，**默认0xff**                                 |
|   in_period   |   int    | 判定在围栏内的扫描周期数 范围1-10 **默认2**                  |
|  out_period   |   int    | 判定离开围栏的扫描周期数 范围1-10 **默认2**                  |

表格 20 围栏参数表

围栏参数表采用连续编码方式【解析前先将16进制字符串转换为16进制数组】

例如456789 -->0x45,0x67,0x89

<table>
  	<tr>
      <td><center><b>内容</b></center></td>
      <td><center><b>类型</b></center></td>
      <td><b>含义</b></td>
  </tr>
  <tr>
  		<td rowspan="3">第一围栏数据</td>
      <td>围栏功能</td>
      <td>
    		一字节8bit状态位标识，0关闭，1使能：<br />
				[bit 0] 在围栏范围内关闭NB <br />
				[bit 1] 进入提醒【触发上报事件】<br />
				[bit 2] 离开提醒【触发上报事件】<br />
                [bit 4] 进入围栏关闭GPS，离开则开启【根据设置】
    </td>
  </tr>
  <tr>
      <td>MAC地址个数</td>
      <td>一个字节【最大值5】</td>
  </tr>
  <tr>
      <td>连续MAC地址</td>
      <td>MAC地址个数*6字节[BT围栏7字节，最后一个字节表示匹配长度]</td>
  </tr>
  <tr>
  		<td>第二个围栏数据</td>
      <td>内容同上</td>
      <td></td>
  </tr>
  <tr>
  		<td>第三个围栏数据</td>
      <td>内容同上</td>
      <td></td>
  </tr>
  <tr>
  		<td>......</td>
      <td></td>
      <td></td>
  </tr>
  </table>
```json
示例：设置两个WIFI围栏:{"setSystemParameter":"set","type":"wifiscan","state":"1,3,2147483649,300,10,2,5","value":"0F018CD495000987060F018CD49500128806","dev":"1566197383,FC3554B0D5EC"}")
```

表格 21 自定义提醒参数表

<table>
  <tr>
  	<td><center><b>内容</b></center></td>
    <td><center><b>类型</b></center></td>
    <td><b>含义</b></td>
  </tr>
  <tr>
  	<td rowspan="7">第一自定义提醒数据</td>
    <td>长度</td>
    <td>一字节，5+N*2+提醒名称长度</td>
  </tr>
  <tr>
    <td>提醒编号</td>
    <td>一字节0-7</td>
  </tr>
  <tr>
    <td>提醒类型</td>
    <td>
      	一字节<br />
				1：运动    2：约会   3：喝水<br />
				4：吃药    5：睡觉   6：自定义提醒
</td>
  </tr>
  <tr>
    <td>提醒时间总数【N】</td>
    <td>一个字节，表示一天中有几个时间点去提示【最大值6】</td>
  </tr>
  <tr>
    <td>提醒时间</td>
    <td>N*2字节</td>
  </tr>
  <tr>
    <td>星期重复</td>
    <td>一个字节，从低位到高位依次表示星期日到星期六，最高位(第7位)默认为0，其他位0表示该星期不重复，1表示该星期重复</td>
  </tr>
  <tr>
    <td>提醒名称</td>
    <td>使用unicode编码，最大44个字节长度，相当于可有22个ascii或中文；如果提醒类型是1~5，则不用传递提醒语</td>
  </tr>
  <tr>
  	<td>第二自定义提醒数据</td>
    <td></td>
    <td></td>
  </tr>
</table>


最大8个提醒数据，但注意不可超过数据包最大长度，可以分多个包发送明。设置查询删除操作手环都将会返回所有提醒信息。

```json
示例：
删除编号0~7的提醒
{"setSystemParameter":"del","type":"remind","state":"","value":"0001020304050607","dev":"1566197383,8cd49500fffe"}
设置两个提醒
{"setSystemParameter":"set","type":"remind","state":"","value":"0D010601113200310032003300070001010f3000","dev":"1566197383,8cd49500fffe"}
查询血氧连续监测状态
{"setSystemParameter":"query","type":"spo2","dev":"1566197383,8cd49500fffe"}
设置打开血氧连续监测状态，频率为10分钟
{"setSystemParameter":"set","type":"spo2","state":"open","value":"10","dev":"1566197383,8cd49500fffe"}
查询血氧连续监测状态响应
{"ackSetSystemParameter":"ok","type":"spo2","state":"open","value":"10","dev":"1566197383,8cd49500fffe"}
```

### 4.4. 离线数据（需要存储的数据，先存储再上报）

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于终端是直接和服务器通信，为了减轻服务器压力，离线接口都将会有主动推送，但推送频率不高。【存储最近7天数据】 

#### 4.4.1 心率离线数据

终端本地储存一段时间心率数据，服务器通过主动请求获取离线心率数据。

心率间隔5秒，24小时数据分包288包，每包60个心率（5分钟心率）,总包数288。

心率离线数据会在定时信息上报的时候上报新的离线数据。

服务器主动请求数据：

表格 22 请求心率数据

|    **键**    | **类型** | **含义**                                                     |
| :----------: | :------: | ------------------------------------------------------------ |
| heartRequest |  string  | 年月日，如：20201014，为空则默认请求当天数据                 |
|    start     |   int    | 请求的心率的起始包序号。                                     |
|     end      |   int    | 请求的心率的结束包序号。【最大请求10包，start-end < 10】     |
|    packs     |  string  | 逗号隔开，最多10个  如果和start，end同时存在，只处理packs字段 |
|     dev      |  string  | msgid，mac。                                                 |

表格 23 手环上报心率数据

|      **键**      | **类型** | **含义**                                               |
| :--------------: | :------: | ------------------------------------------------------ |
| heartOfflineData |  string  | 上报的心率数据  说明：当数据全部为0x00或者0xff则不上报 |
|      count       |   int    | 上报的心率个数。【固定60】                             |
|       pack       |   int    | 心率包的包序号。【1-288】                              |
|     interval     |   int    | 心率数据的时间间隔，单位：秒。【固定为5】              |
|       date       |  string  | 年月日，如：20201014。                                 |
|       dev        |  string  | msgid，mac。                                           |

```json
示例：
请求：{"heartRequest":"20210108","start":187,"pack":187,"dev":"1610120225,e990c0fc3e3f"}
回复：{"heartOfflineData":"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0","count":60,"pack":187,"interval":5,"date":"20210108","dev":"1610120225,e990c0fc3e3f"}
```

**注意：**

1. 一天数据的总包数可通过心率数据间隔时间和上报个数计算出来，固定间隔时间5s，固定每包个数为60，总包数为86400(一天秒数)/5/60=288包数据。

2. 如果请求的心率包内容都为0x00或者0xFF，则终端不回应，系统可以使用4.11佩戴状态离线数据概况，判断哪些包包含有效数据。

#### 4.4.2 睡眠离线数据

表格 24 请求睡眠数据

|    **键**    | **类型** | **含义**                                                |
| :----------: | :------: | ------------------------------------------------------- |
| rsqSleepData |  string  | 年月日，如：20201014，为空则默认请求当天数据            |
|     type     |  string  | 请求统一使用”1“，终端根据使用算法的不同，回复不同的数据 |
|     dev      |  string  | msgid，mac                                              |

表格 25 手环上报睡眠数据

|    **键**    | **类型** | **含义**                                                     |
| :----------: | :------: | ------------------------------------------------------------ |
| ackSleepData |  string  | type 1:<br />16进制字符串【72字节】，转换为16进制数组共36字节，每两个bit表示一个10分钟的睡眠质量,0:活动，1：浅度，2：深度 3：未监测<br /> 例如<br />"a1a2a3a4aaaaaaaaaaaaaaaaaaaaaeaaaaaaaaaaa0000c00f0fc03030aaaaaa"  转换为:{0xa1,0xa2..........}<br />说明：当数据全部为0x00或者0xff则不上报<br />type 2:<br />16进制字符串[300字节]，转换为16进制数组共150字节， <br />每三个字节一组，分别表示：[睡眠状态 时 分]  睡眠状态：0 清醒, 1 浅睡, 2  深睡, 3 快速动眼, 255 无效数据 |
|    ydata     |  string  | 同上，昨天的睡眠原始数据[type为1时存在]                      |
|  sleeptime   |  string  | type为1时：<br />总睡眠时间，深睡时间，浅睡时间，中间逗号隔开<br />例如总睡眠时间为6小时，深睡为2小时，浅睡为3小时20分，则内容为："360,120,200"<br />type为2时[只上报当天，请求其他日期为0]：总睡眠时间，深睡时间，浅睡时间，眼动睡眠时间. |
|     type     |  string  | 0：睡眠数据，<br />1：WK睡眠算法数据<br />2：CWM算法数据[B10C项目使用新的算法]<br />[终端根据算法情况上报] |
|     pack     |   int    | 包序号【1-2】                                                |
|    total     |   int    | 总包数【固定为2】                                            |
|     date     |  string  | 年月日，如：20201014                                         |
|     dev      |  string  | msgid，mac                                                   |

```json
示例：
请求：
{"rsqSleepData":"20210108","type":"1","dev":"1566197383,8cd49500fffe"}
返回：
{"ackSleepData":"bfffbaa6eba9feebaefaffffffffffffffffffffffffffffffffffffffffffffffffffff","ydata":"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0f0000faf2","sleeptime":"460,10,300","type":"1","date":"20210108","dev":"1637414811,8cd49500fffe"}
```

**注意：**

1. type 1终端每天定时上报8:00, 9:00, 10:00,11:00各上报一次

2. type 2 终端每天醒来后主动上报

#### 4.4.3 计步离线数据

表格 26 请求计步数据

|   **键**    | **类型** | **含义**                                     |
| :---------: | :------: | -------------------------------------------- |
| rsqStepData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|     dev     |  string  | msgid，mac                                   |

表格 27 手环上报计步数据

|  **键**  | **类型** | **含义**                                                     |
| :------: | :------: | ------------------------------------------------------------ |
| stepData |  string  | 计步数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />单位步，每两个字节代表5分钟步数，低字节在前，共计6小时数据 |
|   pack   |   int    | 包序号【1-4】                                                |
|  total   |   int    | 总包数【固定为4】                                            |
|   date   |  string  | 年月日，如：20201014                                         |
|   dev    |  string  | msgid，mac                                                   |

```json
示例：
请求：
{"rsqStepData":"20210107","dev":"1566197383,8cd49500fffe"}
返回：
{"stepData":"0a002200000000000000000000000000200038000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","pack":"1","total":"4","data":"20210107","dev":"1566197383,8cd49500fffe"}
```

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据

2. 计步离线数据不主动上报

#### 4.4.4 热量离线数据

表格 28 请求热量数据

|     **键**     | **类型** | **含义**                                     |
| :------------: | :------: | -------------------------------------------- |
| rsqCalorieData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|      dev       |  string  | msgid，mac                                   |

表格 29 手环上报热量数据

|   **键**    | **类型** | **含义**                                                     |
| :---------: | :------: | ------------------------------------------------------------ |
| calorieData |  string  | 卡路里数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />单位步，每两个字节代表5分钟内的卡路里消耗数据，低字节在前，共计6小时数据 |
|    pack     |   int    | 包序号【1-4】                                                |
|    total    |   int    | 总包数【固定为4】                                            |
|    date     |  string  | 年月日，如：20201014                                         |
|     dev     |  string  | msgid，mac                                                   |

```json
示例：
{"rsqCalorieData":"20210107","dev":"1566197383,8cd49500fffe"}
返回：
{"calorieData":"0a002200000000000000000000000000200038000900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","pack":"1","total":"4","data":"20210107","dev":"1566197383,8cd49500fffe"}
```

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据

2. 热量离线数据不主动上报

#### 4.4.5 血氧离线数据

5分钟存储一次数据，全天共288个字节

表格 30 请求血氧数据

|   **键**    | **类型** | **含义**                                     |
| :---------: | :------: | -------------------------------------------- |
| rsqSpo2Data |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|     dev     |  string  | msgid，mac                                   |

表格 31 手环上报血氧数据

|  **键**  | **类型** | **含义**                                                     |
| :------: | :------: | ------------------------------------------------------------ |
| spo2Data |  string  | 血氧数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />每个字节代表一个血氧数据，低字节在前，共计12小时数据【0或者ff表示没有佩戴或者没有测量】 |
|   pack   |   int    | 包序号【1-2】                                                |
|  total   |   int    | 总包数【固定2】                                              |
|   date   |  string  | 年月日，如：20201014                                         |
|   dev    |  string  | msgid，mac                                                   |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据
2. 血氧离线数据不主动上报

#### 4.4.6 温度离线数据

5分钟存储一次数据12*4*24，全天共1152个字节

表格 32 请求温度数据

|   **键**    | **类型** | **含义**                                     |
| :---------: | :------: | -------------------------------------------- |
| rsqTempData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|     dev     |  string  | msgid，mac                                   |

表格 33 手环上报温度数据

|  **键**  | **类型** | **含义**                                                     |
| :------: | :------: | ------------------------------------------------------------ |
| tempData |  string  | 温度数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />每四个字节代表一组温度数据，【2byte体温+2byte环境温度】<br />体温和环境温度，低字节在前，共计3小时数据【*0.005得到实际温度】<br />【0或者ff表示没有佩戴或者没有测量】 说明：当体温有有效数据才会上报 |
|   pack   |   int    | 包序号【1-8】                                                |
|  total   |   int    | 总包数【固定8】                                              |
|   date   |  string  | 年月日，如：20201014                                         |
|   dev    |  string  | msgid，mac                                                   |

```json
示例：
请求：
{"rsqTempData":"20210107","dev":"1566197383,8cd49500fffe"}
返回：
{"tempData":"6a1a7e1a951a861a941a621a651a741a6f1a401a4f193019e219b11a6e1a3d1a3a1a1b1a121a141a131a631a6e1a911a991a701a491a4e1a5c1a4f1a401a671a8b1ab91adf1af91a0f1b231b311b531b4e1b551b571b5e1b4c1bfd1a981a541a441a771ad01af01afe1a141b311b281b2d1b371b441b501b511b3c1b311b2f1b0a1ba11a4a1a441a691a821aa31ab91a","pack":"1","total":"8","date":"20210416","dev":"1618588688,c48d8ce87eeb"}
```

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据

2. 温度离线数据不主动上报

#### 4.4.7 RRI离线数据

5s一次数据，包总数为288包。

表格 34 请求RRI数据

| **键**     | **类型** | **含义**                                                     |
| ---------- | -------- | ------------------------------------------------------------ |
| rsqRriData | string   | 年月日，如：20201014                                         |
| start      | int      | 请求的RRI的起始包序号。【1-288】                             |
| end        | int      | 请求的RRI的结束包序号。【1-288】                             |
| packs      | string   | 逗号隔开，最多10个  如果和start，end同时存在，只处理packs字段 |
| dev        | string   | msgid，mac。                                                 |

表格 35 手环上报RRI数据

|  **键**  | **类型** | **含义**                                |
| :------: | :------: | --------------------------------------- |
| rriData  |  string  | 上报的RRI数据。【参考心率】             |
|  count   |   int    | 上报的RRI个数。【固定60】               |
|   pack   |   int    | RRI包的包序号。【1-288】                |
| interval |   int    | RRI数据的时间间隔，单位：秒。【固定5s】 |
|   date   |  string  | 年月日，如：20201014                    |
|   dev    |  string  | msgid，mac。                            |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据
2. RRI离线数据不主动上报

#### 4.4.8 气压离线数据【仅B10c支持】

每10分钟一次，4个字节表示一个有效数据，全天数据576个字节

表格 36 请求气压数据

|     **键**      | **类型** | **含义**                                     |
| :-------------: | :------: | -------------------------------------------- |
| rsqPressureData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|       dev       |  string  | msgid，mac                                   |

表格 37 手环上报气压数据	

|    **键**    | **类型** | **含义**                                                     |
| :----------: | :------: | ------------------------------------------------------------ |
| pressureData |  string  | 气压数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />每四个字节代表一个气压数据(3byte 整数【低字节在前】 + 1byte 小数) ，共计6小时数据 |
|     pack     |   int    | 包序号【1-4】                                                |
|    total     |   int    | 包总数【固定4包】                                            |
|     date     |  string  | 年月日，如：20201014                                         |
|     dev      |  string  | msgid，mac                                                   |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xff，则终端不回应，系统可以使用1.4.4.11协议获取离线数据概况，判断哪些包包含有效数据
2. 气压离线数据不主动上报

#### 4.4.9 血压离线数据

5分钟一次，3个字节表示一个有效数据【高压，低压，诊断值】，全天共864个字节

表格 38 请求血压数据

|  **键**   | **类型** | **含义**                                     |
| :-------: | :------: | -------------------------------------------- |
| rsqBpData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|    dev    |  string  | msgid，mac                                   |

表格 39 手环上报血压数据

| **键** | **类型** | **含义**                                                     |
| :----: | :------: | ------------------------------------------------------------ |
| bpData |  string  | 血压数据<br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共144字节<br />每3个字节代表一个数据(高压，低压，诊断值)  ，共计4小时数据<br />诊断值:<br />      0 正常<br />      1 高压过高<br />      2 高压过低<br />      3 低压过高<br />      4 低压过低 <br />      5 无效数据 |
|  pack  |   int    | 包序号【1-6】                                                |
| total  |   int    | 总包数【固定6】                                              |
|  date  |  string  | 年月日，如：20201014                                         |
|  dev   |  string  | msgid，mac                                                   |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xFF，则终端不回应，系统可以使用4.11协议获取离线数据概况，判断哪些包包含有效数据
2. 血压离线数据不主动上报

#### 4.4.10 离线信息状态

1. 开机主动发送离线信息状态

2. 时间变更的时候发送前一天的离线信息状态

表格 40 请求离线信息状态

|     **键**     | **类型** | **含义**                                     |
| :------------: | :------: | -------------------------------------------- |
| rsqGeneralData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|      dev       |  string  | msgid，mac。                                 |

表格 41 回复/主动上报离线信息状态

|   **键**    | **类型** | **含义**                                                     |
| :---------: | :------: | ------------------------------------------------------------ |
| generalData |  string  | 年月日，如：20201014                                         |
|    date     |  string  | 显示存在数据的日期，每天固定8个字节 例如  2020101420201015，最大56字节 |
|    heart    |  string  | 16进制字符串72字节，每两个字节表示一个byte  每一位表示一个包的状态<br />0为无有效数据<br />1为有效数据<br />包序号定位方法：<br />byte=(pack -1)/8 <br />bit=(pack-1)%8 |
|    sleep    |  string  | 1字节或者2字节 0：无睡眠数据 1：有睡眠数据                   |
|    step     |  string  | 4字节 0000：无计步数据 1111：有计步数据                      |
|   calorie   |  string  | 4字节 0000：无热量数据 1111：有热量数据                      |
|    spo2     |  string  | 2字节 00：无血氧数据 11：有血氧数据                          |
|    temp     |  string  | 8字节 00000000：有温度数据 11111111：有温度数据              |
|     rri     |  string  | 同heart                                                      |
|  pressure   |  string  | 4字节 0000：无气压数据 1111：有气压数据                      |
|     bp      |  string  | 6字节 000000：无血压数据 111111：有血压数据                  |
|     dev     |  string  | msgid，mac。                                                 |

```json
示例：
{"generalData":"20210414","date":"20210414202104152021041620210410202104112021041220210413","heart":"ffff7ff8ffffffffffff7fe09dff00020000000000000000000000000000000000000000","sleep":"1","step":"1100","calorie":"1110","temp":"00000001","spo2":"11","rri":"ffff7ff8ffffffffffff7fe09dff00020000000000000000000000000000000000000000","pressure":"1111","bp":"111111","dev":"1618588086,c48d8ce87eeb"} 
```

#### 4.4.11 佩戴状态离线数据

 5s记录一个状态，用1位标记[0为佩戴，1为未佩戴]，一个字节记录40s的佩戴状态，40s存储一次

表格 42 请求佩戴状态数据

|   **键**    | **类型** | **含义**                                     |
| :---------: | :------: | -------------------------------------------- |
| rsqWearData |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|     dev     |  string  | msgid，mac                                   |

表格 43 手环上报佩戴状态数据

|  **键**  | **类型** | **含义**                                                     |
| :------: | :------: | ------------------------------------------------------------ |
| wearData |  string  | 佩戴状态数据  为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共180字，共计2小时数据  一位表示一个佩戴状态：0表示佩戴，1表示未佩戴 |
|   pack   |   int    | 包序号【1-12】                                               |
|  total   |   int    | 总包数【固定12】                                             |
|  status  |  string  | 12字节000000000000：000000000000表示没有数据，111111111111表示有数据 |
|   date   |  string  | 年月日，如：20201014                                         |
|   dev    |  string  | msgid，mac                                                   |

#### 4.4.12 HRV离线数据

5分钟存储一次，一次20字节 一天288个定位数据，共5760字节

HRV记录5个参数

表格 44 请求HRV离线数据

| **键** | **类型** | **含义**                                     |
| :----: | :------: | -------------------------------------------- |
| rsqHRV |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|  dev   |  string  | msgid，mac                                   |
|  pack  |  string  | 请求第几包数据[无则表示所有]最大32           |

表格 45 手环上报定位离线数据

|   **键**   | **类型** | **含义**                                                     |
| :--------: | :------: | ------------------------------------------------------------ |
| offlineHRV |  string  | 16进制字符串，需转换为16进制数组<br />每25个字节为一组HRV，每5个字节表示HRV值[分别为SDNN，TP，LF，HF，VLF]<br />说明：<br />5B SDNN {float sdnn = (int)[1,4] + ((int)[5])/255.0;}<br />5B TP   {float tp   = (int)[1,4] + ((int)[5])/255.0;}<br />5B LF   {float lf   = (int)[1,4] + ((int)[5])/255.0;}<br />5B HF   {float hf   = (int)[1,4] + ((int)[5])/255.0;}<br />5B VLF  {float vlf  = (int)[1,4] + ((int)[5])/255.0;} |
|    pack    |   int    | 包序号【1-36】                                               |
|   total    |   int    | 总包数【固定36】                                             |
|   status   |  string  | 18字节000000000000000000：<br />000000000000000000表示没有数据，<br />111111111111111111表示有数据 |
|    date    |  string  | 年月日，如：20201014                                         |
|    dev     |  string  | msgid，mac                                                   |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xFF，则终端不回应，系统可以使用4.11协议获取离线数据概况，判断哪些包包含有效数据
2. HRV离线数据不主动上报

#### 4.4.13 定位离线数据

5分钟存储一次，一次11字节 一天288个定位数据，共3168字节

定位数据格式参考：<u>定位数据格式表格</u>

表格 46 请求定位离线数据

|   **键**    | **类型** | **含义**                                     |
| :---------: | :------: | -------------------------------------------- |
| rsqLocation |  string  | 年月日，如：20201014，为空则默认请求当天数据 |
|     dev     |  string  | msgid，mac                                   |

表格 47 手环上报定位离线数据

|     **键**      | **类型** | **含义**                                                     |
| :-------------: | :------: | ------------------------------------------------------------ |
| offlineLocation |  string  | 参考 [定位数据格式表格[无定位时间\]](#定位数据格式表格) <br />为16进制字符串，需转换为16进制数组【转换方式参考睡眠数据】，共176字节，共计16个定位点 |
|      pack       |   int    | 包序号【1-18】                                               |
|      total      |   int    | 总包数【固定18】                                             |
|     status      |  string  | 18字节000000000000000000：<br />000000000000000000表示没有数据，<br />111111111111111111表示有数据 |
|      date       |  string  | 年月日，如：20201014                                         |
|       dev       |  string  | msgid，mac                                                   |

**注意：**

1. 如果请求的数据包内容全为0x00或者0xFF，则终端不回应，系统可以使用佩戴状态协议获取离线数据概况，判断哪些包包含有效数据
2. 定位离线数据不主动上报

### 4.5 事件信息上报

事件上报，通信模组启动需要时间，一般会在事件触发后20s内上报

表格 48 事件信息上报

|    **键**    | **类型** | **含义**                                                     |
| :----------: | :------: | ------------------------------------------------------------ |
|    system    |  string  | 系统事件合并上报【32位表示】低字节先发送                     |
|     type     |  string  | 终端型号：X3，X3W，B10  格式：终端型号[_客户标记][_功能标记][_其他标记]<br />例如x3w_Pgh3011<br />【开关机，低电量事件字段】 |
|    nbver     |  string  | nb模组版本号【开关机，低电量事件字段】                       |
|     lver     |  string  | 固件版本：版本号_编译时间  【开关机，低电量事件字段】        |
|   protocol   |  string  | 协议版本标识【开关机，低电量事件字段】                       |
|     ccid     |  string  | 物联网卡号【开关机，低电量事件字段】                         |
|     imei     |  string  | 终端IMEI号码 15位【开关机，低电量事件字段】                  |
|     dev      |  string  | msgid，mac【公共字段】                                       |
|    sport     |  string  | 运动事件数据参看运动数据表【运动事件才有这个字段】【运动事件字段】 |
|    heart     |   int    | 当前心率值【有心率异常事件才有该字段】                       |
|     temp     |  float   | 当前温度值【有温度异常事件才有该字段】                       |
|     spo2     |   int    | 当前血氧值【有血样异常事件才有该字段】                       |
|   pressure   |   int    | 当前气压值【有气压异常事件才有该字段】                       |
|  diastolic   |   int    | 当前低压值【有血压低压异常事件才有该字段】                   |
|   systolic   |   int    | 当前高压值【有血压高压异常事件才有该字段】                   |
|    check     |  string  | 打卡类型和打卡时间，中间逗号隔开                             |
|     sos      |   int    | SOS报警时间                                                  |
|  spo2_test   |  string  | 手动测量血氧值+测量时间，中间逗号隔开                        |
|   bp_test    |  string  | 手动测量血压值 高压+低压+测量时间，中间逗号隔开              |
| stroke_test  |  string  | 手动测量中风风险值【百分比】+测量时间，中间逗号隔开          |
|    fence     |  string  | 离开围栏范围：无内容  进入围栏范围：直接上报围栏序号+时间+MAC+信号，中间逗号隔开。 |
|    f_type    |  string  | 围栏类型 0为WIFI围栏 1位蓝牙围栏  [fence事件字段]            |
|  fall_alarm  |   int    | 跌倒报警时间                                                 |
|  device_id   |  string  | 同蓝牙广播终端标识                                           |
| LocationData |  string  | 上报最新的定位信息[sos，fall_alarm，manual_gps事件有该字段]格式参考1.4.7 |
|  manual_gps  |   int    | 请求定位时间[manual_gps字段]                                 |
|  sport_cwm   |  string  | CWM运动事件数据参看CWM运动数据表【运动事件才有这个字段】【CWM运动事件字段】 |
|    charge    |  string  | 充电状态<br />  "charge_status,charge_in_time,charge_full_time,charge_out_time"<br />   charge_status:<br />   0x01-插入充电器 0x02-开始充电 0x04-结束充电<br />   0x08-充满电 0x10-拔掉充电器 |

```json
示例：
开机事件：
{"system":"00000001","type":"X3W","nbver":"NB81_Y0C_41F00_001033Lierda6166112","lver":"04161021","protocol":"20210403","ccid":"89860479102091085199","imei":"863659042859594","dev":"1618589821,c48d8ce87eeb"}
开机事件和温度预警事件：
{"system":"00000021","type":"X3W","nbver":"NB81_Y0C_41F00_001033Lierda6166112","lver":"04161021","protocol":"20210403","ccid":"89860479102091085199","imei":"863659042859594","temp":37.45,"dev":"1618589821,c48d8ce87eeb"}
```

表格 49 事件内容

|    **事件**    |       **含义**       | **值**     |
| :------------: | :------------------: | ---------- |
|       on       |       终端开机       | 0x00000001 |
|    lowpower    |  终端电量低停止上报  | 0x00000002 |
|      off       |       终端关机       | 0x00000004 |
|      sos       |       sos信号        | 0x00000008 |
|     heart      |       心率异常       | 0x00000010 |
|      temp      |       温度异常       | 0x00000020 |
|      spo2      |       血氧异常       | 0x00000040 |
|    pressure    |       气压异常       | 0x00000080 |
|   diastolic    |     血压低压异常     | 0x00000100 |
|    systolic    |     血压高压异常     | 0x00000200 |
|     check      |       打卡事件       | 0x00000400 |
|  sport/sport2  |       运动事件       | 0x00000800 |
|   spo2_test    |   手动测试血氧事件   | 0x00001000 |
| bpressure_test |   手动测试血压事件   | 0x00002000 |
|  stroke_test   | 手动测试中风风险测试 | 0x00004000 |
|     fence      |       围栏事件       | 0x00008000 |
|   fall_alarm   |     跌倒告警事件     | 0x00010000 |
|  device_info   |   定时上报系统信息   | 0x00020000 |
|   manual_gps   |     手动定位事件     | 0x00040000 |
|   sport_cwm    |     CWM运动事件      | 0x00080000 |
|     charge     |       充电事件       | 0x00100000 |

以上事件，有多个事件的时候进行统一上报

表格 50 运动数据格式【sport/sport2】

<table>
  <tr>
  	<td colspan="3">运动事件 数量N【N最大值5】</td>
    <td>说明</td>
  </tr>
  <tr>
  	<td rowspan="13">运动事件数据</td>
    <td rowspan="9">第一个运动事件<br />
    【sport总共18字节，转换为16进制字符串后36字节】<br />
    【sport2总共24字节，转换为16进制字符串后48字节】
</td>
    <td>开始时间</td>
    <td>4字节 本地时间的秒数 低字节先传</td>
  </tr>
  <tr>
    <td>结束时间</td>
    <td>4字节 本地时间的秒数 低字节先传</td>
  </tr>
  <tr>
    <td>包类型</td>
    <td>1字节，同蓝牙协议 目前用到1【运动类型为00】4【运动类型为其他值】</td>
  </tr>
  <tr>
    <td>运动类型</td>
    <td>
      00：无运动类型<br />
			01: 徒步<br />
			02：跑步<br />
			03: 爬山<br />
			04：球类运动<br />
			05：力量训练<br />
			06：有氧运动<br />
			FE: 自定义运动
</td>
  </tr>
  <tr>
    <td>消耗热量</td>
    <td>4字节 消耗热量,单位KCal 低字节先传</td>
  </tr>
  <tr>
    <td>总步数</td>
    <td>4字节 总步数，单位步 低字节先传</td>
  </tr>
  <tr>
    <td>里程</td>
    <td>4字节 里程,单位cm 低字节先传 sport2专用</td>
  </tr>
  <tr>
    <td>最大心率</td>
    <td>1字节 运动最大心率 sport2专用</td>
  </tr>
  <tr>
    <td>平均心率</td>
    <td>1字节 运动平均心率 sport2专用</td>
  </tr>
  <tr>
    <td>第二个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
  <tr>
    <td>第三个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
  <tr>
    <td>第四个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
  <tr>
    <td>第五个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
</table>



表格 51 运动数据格式【sport_cwm】

<table>
  <tr>
  	<td colspan="3">运动事件 数量N【N最大值3】</td>
    <td>说明</td>
  </tr>
  <tr>
  	<td rowspan="11">运动事件数据</td>
    <td rowspan="9">第一个运动事件<br />
【总共23字节，转换为16进制字符串后46字节】
</td>
    <td>开始时间</td>
    <td>4字节 本地时间的秒数 低字节先传</td>
  </tr>
  <tr>
    <td>运动时长</td>
    <td>4字节 本地时间的秒数 低字节先传</td>
  </tr>
  <tr>
    <td>运动类型</td>
    <td>
      00：远足<br />
			01:跑步<br />
			02:跑步机<br />
			03:力量训练<br />
			04:跳绳<br />
			05:室内自行车<br />
			06:山地自行车<br />
			07:高强度训练<br />
			08:自由训练<br />
			09:游泳<br />
			0A:登山<br />
			0B:瑜伽
</td>
  </tr>
  <tr>
    <td>消耗热量</td>
    <td>2字节 消耗热量,单位KCal 低字节先传</td>
  </tr>
  <tr>
    <td>最大心率</td>
    <td>1字节</td>
  </tr>
  <tr>
    <td>平均心率</td>
    <td>1字节</td>
  </tr>
  <tr>
    <td>距离</td>
    <td>4字节 距离，单位米 低字节先传</td>
  </tr>
  <tr>
    <td>步数</td>
    <td>4字节 总步数，单位步 低字节先传</td>
  </tr>
  <tr>
    <td>平均配速</td>
    <td>2字节 总步数，单位步 低字节先传</td>
  </tr>
  <tr>
    <td>第二个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
  <tr>
    <td>第三个运动事件</td>
    <td>......</td>
    <td></td>
  </tr>
</table>


**注释：**

sos, fall_alarm事件上报

1. 当长按按键时终端上报sos事件【上报WIFI定位或者基站定位信息】。

2. 支持跌倒告警的终端检测到跌倒的时候马上上报fall_alarm事件【上报WIFI定位或者基站定位信息】

3. 同时开启一次GPS定位，定位成功通过对应事件上报【由于GPS定位需要时间，上报会有延时】

4. 无WIFI定位的终端【X3W,X6】会开启WIFI扫描，上报1.4.9WIFI信息上报。

5. sport_cwm运动事件会同事上报运动轨迹[使用原始数据协议上报]，参考文档《吾控健康原始数据协议文档》5.3小节

### 4.6 Wi-Fi信息上报

主动上报接口，终端扫描周围AP信息，数据用于Wi-Fi扫描定位。

表格 52 Wi-Fi信息上报

| **键** | **类型** | **含义**                                     |
| :----: | :------: | -------------------------------------------- |
| apInfo |  string  | mac，rssi，每个ap用分号间隔,最多30组ap信息。 |
| apNum  |  string  | 扫描到的ap数量。                             |
|  time  |  string  | 扫描该组mac时的utc时间。                     |

```json
{"apInfo":"50:bd:5f:35:b7:82,-30;70:a8:e3:5f:70:cc,-76;d8:8a:dc:fe:a8:bd,-45;d8:8a:dc:fe:a8:bb,-44;0e:54:15:36:7a:a9,-41", "apNum":"5","time":"16021343235" }
```

手环AP数据会做一定的缓存，等到数据缓存满或者有其他事件上报时同时进行上报，可通过键‘time’的值确定扫描的时间。

**通过AP信息定位：**

可通过第三方Wi-Fi定位接口实现定位，通过http方式将mac，rssi发送请求定位结果。服务器可将Wi-Fi数据缓存，等待需要查看定位的时候再将数据请求转换为定位数据，或者直接将数据请求转换为定位数据后再缓存。

### 4.7 定位相关协议

表格 53 服务器请求GPS定位

|  **键**   | **类型** | **含义**                                                     |
| :---------: | :------: | ------------------------------------------------------------ |
|  getgps   |  string  | 终端mac，终端收到数据后会检查mac。                           |
|    dev    |  string  | msgid，mac                                                   |
|   type    |   int    | 0单次定位；1多次定位；2连续定位[10s定位一次] 3关闭定位<br />说明：<br />1. 兼容之前的协议，没有该字段则为单次定位<br />2. type1多次定位可以使用次数[times]控制，也可以使用开始[starttime]结束时间[endtime]控制<br />3. type2连续定位，由字段开始时间，结束时间控制 |
| frequency |   int    | 定位频率单位分钟 范围1-255，**默认5**【type为1时使用,255】    |
|    times    |   int    | 定位次数【type为1时使用】0xff表示一直定位                    |
| starttime |  string  | 定位开始时间【type为1和2时使用】  时间戳【北京时间】         |
|   endtime   |  string  | 定位结束时间【type为1和2时使用】  时间戳【北京时间】<br />**开始结束时间都为0表示一直定位** |
|    flags    |   int    | 定位功能标记<br />0x01:定位完成立即上报<br />0x02:缓存等待NB定时上报<br />0x04:缓存区满了立即上报<br />0x08:使用NB上报频率<br />0x10:睡眠状态下不开启定位<br />0x80:下发数据保存标记 |
|   timeout   |   int    | 定位超时时间, 单位秒 范围60-600，**默认120** |
| bad_timeout |   int    | 信号差定位超时时间, 单位秒 范围10-255，**默认30** |
| delay_off_time | int | 用于过滤定位数据 单位秒 范围20-3600，**默认20** |
| data_interval | int | 上报定位点时间间隔 单位秒 范围1-60，**默认10** |
| data_delay_time | int | 过滤开始定位成功后一段时间的数据 单位秒 范围1-60，**默认10** |
| closeperiod |  string  | GPS关闭时间段1-2,9-10,12-14，最多可设置10个时间段【只能精确到小时】 |

终端增加定位信息存储，共缓存最近40个点【40*15=600字节】

```json
示例：
1. 请求多次定位，定位频率5分钟，不限次数【其他参数使用默认】
{"getgps":"","type":1,"frequency":5,"times":255,"dev":"1566197383,f2729d7c4eb1"}
```

NB终端打开GPS，终端根据情况采用多种定位方式完成定位，采用定时信息上报，若存在缓存定位点[无网络没有及时上报]，则使用cacheLocationDatas上报上报定位数据采用连续编码方式【解析前先将16进制字符串转换为16进制数组】

例如456789 -->0x45,0x67,0x89

表格 54 上报定位数据格式表[LocationData和cacheLocationDatas数据]

|    **字段**    |     **字节**     | **含义**                                 |
| :------------: | :--------------: | ---------------------------------------- |
|   定位点数量   |        1         | 第一个字节表示后面有多少个定位点  最大15 |
| 第一个定位数据 |        15        | 数据格式参考，参考如下定位数据格式表     |
| 第二个定位数据 |        15        | 同第一个定位数据                         |
|      ....      |       ....       | .....                                    |
| 第n个定位数据  | 同第一个定位数据 | 同第一个定位数据                         |

表格 55 定位数据格式[离线定位信息不存储时间]

| 定位类型1B[type] | 0x04:  GPS定位<br />0x03：Wi-Fi定位(Cat1模组)【仅B10C和R9C支持】<br />0x02：基站定位(Cat1 LBS)【仅B10C和R9C支持】<br />0x01：基站定位(NB基站信息)<br />0x00/0xFF：无 |
| :--------------: | ------------------------------------------------------------ |
|   定位准确度2B   | GPS定位[转换为16位整数]： <br />bit[0:3]: 信噪比低于25的卫星数量<br />bit[4:6]: 信噪比低于30大于等于25的卫星数量<br />bit[7:9]: 信噪比低于35大于等于30的卫星数量<br />bit[10:12]: 信噪比低于40大于等于35的卫星数量<br />bit[13:15]: 信噪比大于等于40的卫星数量<br />Wi-Fi定位和基站定位[2，3]：表示定位误差范围，单位米[低字节先传] |
|    定位时间4B    | 定位时间，北京时间置换转换为从1970年开始的秒数[低字节先传]   |
|    定位数据8B    | 定位类型为<br />  0x03  0x02: 纬度4B+经度4B有符号整数[实际值*10000000][高德坐标]  GCJ-02坐标系<br />  0x04:  纬度4B+经度4B有符号整数[实际值*100000][GPS坐标]  WGS84坐标系<br />  定位类型为0x01: tac 4B[实际使用前面2B]+ ci 4B |

```json
GPS定位数据解析：
原始数据 040a002774c462c87f9212fa5ac947
1. 纬度c87f9212 --> 0x12927fc8 --> 311590856[有符号整数] --> 3115.90856[GPS原始数据ddmm.mmmmm] --> 31.26514267[dd+mm.mmmmm/60]
2. 经度fa5ac947 --> 0x47c95afa --> 1204378362[有符号整数] --> 12043.78362[GPS原始数据dddmm.mmmmm] --> 120.729727[ddd+mm.mmmmm/60]
坐标转换到高德地图：
https://lbs.amap.com/demo/jsapi-v2/example/other-gaode/othertoamap
```

表格 56 日常定位缓存信息上报

|       **键**       | **类型** | **含义**                                 |
| :----------------: | :------: | ---------------------------------------- |
| cacheLocationDatas |  string  | 16进制定位数据，用于日常请求定位缓存上报 |
|        dev         |  string  | msgid，mac                               |

### 4.8 蓝牙主机扫描相关协议

默认关闭，请使用系统参数设置接口开启，使用Wi-Fi热点上报同样的数据包，增加Type类型，0表示Wi-Fi AP，1表示BT AP

表格 57 beacon信息上报

| **键** | **类型** | **含义**                                     |
| :----: | :------: | -------------------------------------------- |
| apInfo |  string  | mac，rssi，每个ap用分号间隔,最多30组ap信息。 |
|  type  |  string  | AP类型，0为WIFI AP，1为Beacon AP             |
| apNum  |  string  | 扫描到的ap数量[最大20]                       |
|  time  |  string  | 扫描该组mac时的utc时间。                     |

